reverte 86cbfb5607d4b81b1a993ff689bbd2addd5d3a9b from 2.6.38.6

--- b/drivers/scsi/scsi_sysfs.c
+++ a/drivers/scsi/scsi_sysfs.c
@@ -322,8 +322,14 @@
 		kfree(evt);
 	}
 
+	if (sdev->request_queue) {
+		sdev->request_queue->queuedata = NULL;
+		/* user context needed to free queue */
+		scsi_free_queue(sdev->request_queue);
+		/* temporary expedient, try to catch use of queue lock
+		 * after free of sdev */
+		sdev->request_queue = NULL;
+	}
-	/* NULL queue means the device can't be used */
-	sdev->request_queue = NULL;
 
 	scsi_target_reap(scsi_target(sdev));
 
@@ -931,12 +937,6 @@
 	if (sdev->host->hostt->slave_destroy)
 		sdev->host->hostt->slave_destroy(sdev);
 	transport_destroy_device(dev);
-
-	/* cause the request function to reject all I/O requests */
-	sdev->request_queue->queuedata = NULL;
-
-	/* Freeing the queue signals to block that we're done */
-	scsi_free_queue(sdev->request_queue);
 	put_device(dev);
 }
 
